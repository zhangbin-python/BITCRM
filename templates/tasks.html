{% extends "base.html" %}

{% block title %}Tasks - BITCRM{% endblock %}

{% block extra_css %}
<style>
/* Mobile-friendly table styles */
.table-scroll-touch {
    overflow: auto;
    -webkit-overflow-scrolling: touch;
    position: relative;
    max-height: 400px;
    scrollbar-width: thin;
    scrollbar-color: #adb5bd transparent;
}

.table-scroll-touch::-webkit-scrollbar {
    width: 8px;
    height: 8px;
}

.table-scroll-touch::-webkit-scrollbar-track {
    background: #f1f3f5;
    border-radius: 4px;
}

.table-scroll-touch::-webkit-scrollbar-thumb {
    background-color: #adb5bd;
    border-radius: 4px;
}

/* Ensure table maintains width and doesn't compress */
.table-scroll-touch table {
    min-width: 750px;
    table-layout: fixed;
}

.table-scroll-touch table th,
.table-scroll-touch table td {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 150px;
    min-width: 80px;
}

/* Fixed first column (Status) with proper background */
.table-scroll-touch table th:first-child,
.table-scroll-touch table td:first-child {
    position: sticky;
    left: 0;
    z-index: 2;
    background: inherit;
    min-width: 100px;
}

.table-scroll-touch table thead th:first-child {
    z-index: 3;
    background: #f8f9fa;
}

/* Content column - wider and with truncation */
.table-scroll-touch table td:nth-child(3),
.table-scroll-touch table th:nth-child(3) {
    max-width: none;
    min-width: 250px;
    max-width: 350px;
}

/* Actions column - right aligned */
.table-scroll-touch table th:last-child,
.table-scroll-touch table td:last-child {
    text-align: right !important;
    padding-right: 1rem;
}

/* Status cell styling - for clickable status toggle */
.status-cell {
    cursor: pointer;
    transition: all 0.2s ease;
}

.status-cell:hover {
    opacity: 0.8;
}

.status-date {
    font-size: 0.7rem;
    margin-top: 2px;
    display: block;
}

.status-date.overdue {
    color: #dc3545;
}

.status-date.in-progress {
    color: #198754;
}

.status-date.completed {
    color: #6c757d;
}

/* Owner filter dropdown */
.owner-filter .dropdown-menu {
    min-width: 250px;
    max-height: 300px;
    overflow-y: auto;
}

.owner-filter .dropdown-item {
    padding: 6px 12px;
}

/* Task content truncation */
.task-content {
    font-size: 0.8rem;
    line-height: 1.4;
    max-height: 3.2em;
    overflow: hidden;
    text-overflow: ellipsis;
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
}

.task-content:hover {
    -webkit-line-clamp: unset;
    max-height: none;
}

/* Mobile specific */
@media (max-width: 768px) {
    .table-scroll-touch {
        max-height: 350px;
    }
    
    .table-scroll-touch table {
        min-width: 700px;
    }
    
    .scroll-hint-badge {
        display: inline-flex;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header with Unified Owner Filter and Add Task Button -->
    <div class="row mb-4 align-items-center">
        <div class="col">
            <h1 class="h3 mb-0 text-gray-800">{{ _('Tasks Management') }}</h1>
            <p class="text-muted small mb-0">{{ _('Track and manage your to-do items') }}</p>
        </div>
        
        <!-- Unified Owner Filter Dropdown -->
        <div class="col-auto owner-filter dropdown">
            <button class="btn btn-outline-secondary d-flex align-items-center gap-2 px-4 py-2" 
                    style="min-height: 44px; min-width: 44px;"
                    type="button" 
                    data-bs-toggle="dropdown" 
                    aria-expanded="false">
                <i class="bi bi-funnel"></i>
                <span class="fw-semibold">{{ _('Filter by Owner') }}</span>
            </button>
            <ul class="dropdown-menu dropdown-menu-end p-3" style="min-width: 250px;">
                <li class="mb-2 border-bottom pb-2">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="selectAllOwners" checked>
                        <label class="form-check-label fw-bold" for="selectAllOwners">
                            {{ _('Select All') }}
                        </label>
                    </div>
                </li>
                {% for user in users %}
                <li class="mb-1">
                    <div class="form-check">
                        <input class="form-check-input owner-checkbox" type="checkbox" 
                                id="owner_{{ user.id }}" value="{{ user.id }}" checked>
                        <label class="form-check-label" for="owner_{{ user.id }}">
                            {{ user.username }}
                        </label>
                    </div>
                </li>
                {% endfor %}
            </ul>
        </div>
        
        <!-- Add Task Button -->
        <div class="col-auto">
            <button type="button" 
                    class="btn btn-primary d-flex align-items-center gap-2 px-4 py-2" 
                    style="min-height: 44px; min-width: 44px;"
                    data-bs-toggle="modal" 
                    data-bs-target="#addTaskModal">
                <i class="fas fa-plus fa-lg"></i>
                <span class="fw-semibold">{{ _('Add Task') }}</span>
            </button>
        </div>
    </div>

    <!-- Task Stats -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card border-danger">
                <div class="card-body py-3">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <i class="fas fa-exclamation-circle fa-2x text-danger"></i>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h6 class="mb-0 text-danger">{{ _('Overdue') }}</h6>
                            <h4 class="mb-0">{{ overdue_tasks|length }}</h4>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-success">
                <div class="card-body py-3">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <i class="fas fa-spinner fa-2x text-success"></i>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h6 class="mb-0 text-success">{{ _('In Progress') }}</h6>
                            <h4 class="mb-0">{{ in_progress_tasks|length }}</h4>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-secondary">
                <div class="card-body py-3">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <i class="fas fa-check-circle fa-2x text-secondary"></i>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h6 class="mb-0 text-secondary">{{ _('Completed') }}</h6>
                            <h4 class="mb-0">{{ completed_tasks|length }}</h4>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ============================================================================
         OVERDUE TASKS SECTION
         ============================================================================ -->
    {% if overdue_tasks %}
    <div class="card mb-4 border-danger">
        <div class="card-header bg-danger text-white">
            <h6 class="mb-0"><i class="fas fa-exclamation-circle me-2"></i>{{ _('Overdue Tasks') }}</h6>
        </div>
        <div class="card-body p-0">
            <div class="table-scroll-touch">
                <table class="table table-sm mb-0">
                    <thead class="table-light">
                        <tr>
                            <th class="text-center" style="width: 13%;">{{ _('Status') }}</th>
                            <th class="text-start" style="width: 13%;">{{ _('Owner') }}</th>
                            <th class="text-start" style="width: 20%;">{{ _('Company') }}</th>
                            <th class="text-start" style="width: 44%;">{{ _('Content') }}</th>
                            <th class="text-end" style="width: 13%;">{{ _('Actions') }}</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for task in overdue_tasks %}
                        <tr class="task-row" data-owner-id="{{ task.owner_id or 0 }}">
                            <td class="text-center align-middle status-cell" 
                                data-task-id="{{ task.id }}" 
                                data-current-status="{{ task.status }}">
                                <span class="badge bg-danger">{{ _(task.status) }}</span>
                                <small class="status-date overdue d-block">{{ task.due_date.strftime('%Y-%m-%d') if task.due_date else '' }}</small>
                            </td>
                            <td class="text-start align-middle">{{ task.owner.username if task.owner else '-' }}</td>
                            <td class="text-start align-middle">{{ task.company or '-' }}</td>
                            <td class="text-start align-middle">
                                <span class="task-content" data-bs-toggle="tooltip" data-bs-title="{{ task.content }}">
                                    {{ task.content }}
                                </span>
                            </td>
                            <td class="text-end align-middle">
                                <div class="d-flex gap-2 justify-content-end">
                                    <button type="button" class="btn btn-sm btn-info shadow-sm" 
                                            data-bs-toggle="modal" 
                                            data-bs-target="#editTaskModal{{ task.id }}">
                                        <i class="bi bi-pencil-fill"></i>
                                    </button>
                                    <button type="button" class="btn btn-sm btn-danger shadow-sm"
                                            onclick="if(confirm('{{ _('Are you sure?') }}')) { document.getElementById('deleteForm{{ task.id }}').submit(); }">
                                        <i class="bi bi-trash-fill"></i>
                                    </button>
                                    <form id="deleteForm{{ task.id }}" action="{{ url_for('tasks.delete', task_id=task.id) }}" method="POST" style="display: none;"></form>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- ============================================================================
         IN PROGRESS TASKS SECTION
         ============================================================================ -->
    <div class="card mb-4 border-success">
        <div class="card-header bg-success text-white">
            <h6 class="mb-0"><i class="fas fa-spinner me-2"></i>{{ _('In Progress Tasks') }}</h6>
        </div>
        <div class="card-body p-0">
            {% if in_progress_tasks %}
            <div class="table-scroll-touch">
                <table class="table table-sm mb-0">
                    <thead class="table-light">
                        <tr>
                            <th class="text-center" style="width: 13%;">{{ _('Status') }}</th>
                            <th class="text-start" style="width: 13%;">{{ _('Owner') }}</th>
                            <th class="text-start" style="width: 20%;">{{ _('Company') }}</th>
                            <th class="text-start" style="width: 44%;">{{ _('Content') }}</th>
                            <th class="text-end" style="width: 13%;">{{ _('Actions') }}</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for task in in_progress_tasks %}
                        <tr class="task-row" data-owner-id="{{ task.owner_id or 0 }}">
                            <td class="text-center align-middle status-cell" 
                                data-task-id="{{ task.id }}" 
                                data-current-status="{{ task.status }}">
                                <span class="badge bg-success">{{ _(task.status) }}</span>
                                <small class="status-date in-progress d-block">{{ task.due_date.strftime('%Y-%m-%d') if task.due_date else '' }}</small>
                            </td>
                            <td class="text-start align-middle">{{ task.owner.username if task.owner else '-' }}</td>
                            <td class="text-start align-middle">{{ task.company or '-' }}</td>
                            <td class="text-start align-middle">
                                <span class="task-content" data-bs-toggle="tooltip" data-bs-title="{{ task.content }}">
                                    {{ task.content }}
                                </span>
                            </td>
                            <td class="text-end align-middle">
                                <div class="d-flex gap-2 justify-content-end">
                                    <button type="button" class="btn btn-sm btn-info shadow-sm" 
                                            data-bs-toggle="modal" 
                                            data-bs-target="#editTaskModal{{ task.id }}">
                                        <i class="bi bi-pencil-fill"></i>
                                    </button>
                                    <button type="button" class="btn btn-sm btn-danger shadow-sm"
                                            onclick="if(confirm('{{ _('Are you sure?') }}')) { document.getElementById('deleteForm{{ task.id }}').submit(); }">
                                        <i class="bi bi-trash-fill"></i>
                                    </button>
                                    <form id="deleteForm{{ task.id }}" action="{{ url_for('tasks.delete', task_id=task.id) }}" method="POST" style="display: none;"></form>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center py-4 text-muted">
                <i class="fas fa-check-circle fa-3x mb-3 text-success"></i>
                <p class="mb-0">{{ _('No tasks in progress') }}</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- ============================================================================
         COMPLETED TASKS SECTION
         ============================================================================ -->
    <div class="card mb-4 border-secondary">
        <div class="card-header bg-secondary text-white">
            <h6 class="mb-0"><i class="fas fa-check-circle me-2"></i>{{ _('Completed Tasks') }}</h6>
        </div>
        <div class="card-body p-0">
            {% if completed_tasks %}
            <div class="table-scroll-touch">
                <table class="table table-sm mb-0">
                    <thead class="table-light">
                        <tr>
                            <th class="text-center" style="width: 13%;">{{ _('Status') }}</th>
                            <th class="text-start" style="width: 13%;">{{ _('Owner') }}</th>
                            <th class="text-start" style="width: 20%;">{{ _('Company') }}</th>
                            <th class="text-start" style="width: 44%;">{{ _('Content') }}</th>
                            <th class="text-end" style="width: 13%;">{{ _('Actions') }}</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for task in completed_tasks %}
                        <tr class="task-row" data-owner-id="{{ task.owner_id or 0 }}">
                            <td class="text-center align-middle status-cell" 
                                data-task-id="{{ task.id }}" 
                                data-current-status="{{ task.status }}">
                                <span class="badge bg-secondary">{{ _(task.status) }}</span>
                                <small class="status-date completed d-block">{{ task.due_date.strftime('%Y-%m-%d') if task.due_date else '' }}</small>
                            </td>
                            <td class="text-start align-middle">{{ task.owner.username if task.owner else '-' }}</td>
                            <td class="text-start align-middle">{{ task.company or '-' }}</td>
                            <td class="text-start align-middle text-muted text-decoration-line-through">
                                <span class="task-content" data-bs-toggle="tooltip" data-bs-title="{{ task.content }}">
                                    {{ task.content }}
                                </span>
                            </td>
                            <td class="text-end align-middle">
                                <div class="d-flex gap-2 justify-content-end">
                                    <button type="button" class="btn btn-sm btn-info shadow-sm" 
                                            data-bs-toggle="modal" 
                                            data-bs-target="#editTaskModal{{ task.id }}">
                                        <i class="bi bi-pencil-fill"></i>
                                    </button>
                                    <button type="button" class="btn btn-sm btn-danger shadow-sm"
                                            onclick="if(confirm('{{ _('Are you sure?') }}')) { document.getElementById('deleteForm{{ task.id }}').submit(); }">
                                        <i class="bi bi-trash-fill"></i>
                                    </button>
                                    <form id="deleteForm{{ task.id }}" action="{{ url_for('tasks.delete', task_id=task.id) }}" method="POST" style="display: none;"></form>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center py-4 text-muted">
                <p class="mb-0">{{ _('No completed tasks') }}</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Toast Container -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 9999">
    <div id="saveToast" class="toast align-items-center text-white bg-secondary border-0" role="alert">
        <div class="d-flex">
            <div class="toast-body" id="toastMessage"></div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    </div>
</div>

<!-- Add Task Modal -->
<div class="modal fade" id="addTaskModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{{ _('Add New Task') }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('tasks.add') }}" method="POST">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">{{ _('Task Content') }} *</label>
                        <textarea name="content" class="form-control" rows="3" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">{{ _('Company') }}</label>
                        <input type="text" name="company" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">{{ _('Owner') }}</label>
                        <select name="owner_id" class="form-select">
                            <option value="">{{ _('Select Owner') }}</option>
                            {% for user in users %}
                            <option value="{{ user.id }}" {% if user.id == current_user.id %}selected{% endif %}>
                                {{ user.username }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">{{ _('Due Date') }}</label>
                        <input type="date" name="due_date" class="form-control">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Cancel') }}</button>
                    <button type="submit" class="btn btn-primary">{{ _('Add Task') }}</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Task Modals (for each task) -->
{% for task in overdue_tasks + in_progress_tasks + completed_tasks %}
<div class="modal fade" id="editTaskModal{{ task.id }}" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{{ _('Edit Task') }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('tasks.edit_task', task_id=task.id) }}" method="POST">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">{{ _('Task Content') }} *</label>
                        <textarea name="content" class="form-control" rows="3" required>{{ task.content }}</textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">{{ _('Company') }}</label>
                        <input type="text" name="company" class="form-control" value="{{ task.company or '' }}">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">{{ _('Owner') }}</label>
                        <select name="owner_id" class="form-select">
                            <option value="">{{ _('Select Owner') }}</option>
                            {% for user in users %}
                            <option value="{{ user.id }}" {% if task.owner_id == user.id %}selected{% endif %}>
                                {{ user.username }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">{{ _('Due Date') }}</label>
                        <input type="date" name="due_date" class="form-control" value="{{ task.due_date.strftime('%Y-%m-%d') if task.due_date else '' }}">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Cancel') }}</button>
                    <button type="submit" class="btn btn-primary">{{ _('Save Changes') }}</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endfor %}

<!-- Initialize tooltips and unified owner filter -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl)
    });
    
    // =========================================================================
    // UNIFIED OWNER FILTER - Controls all three tables
    // =========================================================================
    
    const selectAll = document.getElementById('selectAllOwners');
    const checkboxes = document.querySelectorAll('.owner-checkbox');
    const rows = document.querySelectorAll('.task-row');
    
    // Select all handler
    if (selectAll) {
        selectAll.addEventListener('change', function() {
            const isChecked = this.checked;
            checkboxes.forEach(cb => {
                cb.checked = isChecked;
            });
            filterRows();
        });
    }
    
    // Individual checkbox handler
    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            // Update select all checkbox
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            selectAll.checked = allChecked;
            filterRows();
        });
    });
    
    // Filter rows based on selected owners
    function filterRows() {
        const selectedOwners = Array.from(checkboxes)
            .filter(cb => cb.checked)
            .map(cb => cb.value);
        
        rows.forEach(row => {
            const ownerId = row.dataset.ownerId;
            row.style.display = selectedOwners.includes(ownerId) ? '' : 'none';
        });
    }
    
    // =========================================================================
    // TASK STATUS TOGGLE - Click on status badge to toggle
    // In Progress <-> Completed, Overdue -> Completed
    // =========================================================================
    
    document.querySelectorAll('.status-cell').forEach(function(cell) {
        cell.addEventListener('click', function() {
            const taskId = this.dataset.taskId;
            const currentStatus = this.dataset.currentStatus;
            
            // Determine new status
            let newStatus = 'In Progress';
            if (currentStatus === 'In Progress') {
                newStatus = 'Completed';
            } else if (currentStatus === 'Completed') {
                newStatus = 'In Progress';
            } else if (currentStatus === 'Overdue') {
                newStatus = 'Completed';
            }
            
            // AJAX call to toggle status
            fetch(`/api/tasks/${taskId}/toggle-status`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    new_status: newStatus
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('{{ _("Task status updated!") }}');
                    setTimeout(() => {
                        window.location.reload();
                    }, 500);
                } else {
                    showToast(data.error || '{{ _("Error updating task") }}');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('{{ _("Network error") }}');
            });
        });
    });
});

// Toast notification helper
function showToast(message) {
    const toastElement = document.getElementById('saveToast');
    const toast = new bootstrap.Toast(toastElement);
    document.getElementById('toastMessage').textContent = message;
    toast.show();
}
</script>
{% endblock %}
