<!DOCTYPE html>
<html lang="{{ g.lang if g.lang else 'en' }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}BITCRM{% endblock %}</title>
    
    <!-- Bootstrap 5 CSS (Local) -->
    <link href="{{ url_for('static', filename='lib/bootstrap.min.css') }}" rel="stylesheet">
    <!-- Bootstrap Icons (Local) -->
    <link rel="stylesheet" href="{{ url_for('static', filename='lib/bootstrap-icons.css') }}">
    <!-- SortableJS (Local) -->
    <script src="{{ url_for('static', filename='lib/Sortable.min.js') }}"></script>
    <!-- Bootstrap JS (Local) -->
    <script src="{{ url_for('static', filename='lib/bootstrap.bundle.min.js') }}"></script>
    <!-- Chart.js (Local) -->
    <script src="{{ url_for('static', filename='lib/chart.min.js') }}"></script>
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='logo.png') }}">
    
    <style>
        /* Logo Styles - Inline SVG for reliability */
        .logo-img {
            height: 40px;
            width: auto;
            max-width: 100px;
            object-fit: contain;
        }
        
        body {
            background-color: #f8f9fa;
            min-height: 100vh;
        }
        
        .sidebar {
            min-height: 100vh;
            background: linear-gradient(180deg, #1a1a2e 0%, #16213e 100%);
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }
        
        .sidebar .nav-link {
            color: rgba(255,255,255,0.8);
            padding: 12px 20px;
            border-radius: 8px;
            margin: 4px 12px;
            transition: all 0.3s ease;
        }
        
        .sidebar .nav-link:hover, .sidebar .nav-link.active {
            background-color: rgba(255,255,255,0.1);
            color: #fff;
        }
        
        .sidebar .nav-link i {
            margin-right: 10px;
        }
        
        .main-content {
            padding: 20px;
        }
        
        .card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: transform 0.2s ease;
        }
        
        .card:hover {
            transform: translateY(-2px);
        }
        
        .metric-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .metric-card.success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }
        
        .metric-card.warning {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        .metric-card.info {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        
        .table-responsive {
            border-radius: 12px;
            overflow: hidden;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
        }
        
        .navbar {
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .language-switcher {
            cursor: pointer;
            padding: 8px 16px;
            border-radius: 8px;
            transition: background 0.3s ease;
        }
        
        .language-switcher:hover {
            background-color: #f8f9fa;
        }
        
        .flash-messages {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 1050;
        }
        
        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .table th {
            background-color: #f8f9fa;
            font-weight: 600;
            border-bottom: 2px solid #e9ecef;
            white-space: nowrap;
        }
        
        .table td {
            vertical-align: middle;
        }
        
        .page-item.active .page-link {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: #667eea;
        }
        
        .modal-content {
            border: none;
            border-radius: 16px;
        }
        
        /* Column Settings Styles */
        .column-settings-btn {
            padding: 6px 12px;
            font-size: 0.875rem;
        }
        
        .column-item {
            padding: 8px 12px;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            margin-bottom: 6px;
            cursor: grab;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .column-item:hover {
            background: #e9ecef;
        }
        
        .column-item.sortable-ghost {
            opacity: 0.4;
            background: #667eea;
            color: white;
        }
        
        .column-item .drag-handle {
            color: #adb5bd;
            cursor: grab;
        }
        
        .column-item input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }
        
        .column-item .column-label {
            flex: 1;
            cursor: pointer;
        }
        
        .available-columns {
            max-height: 300px;
            overflow-y: auto;
        }
        
        /* Toast notification */
        .toast-notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 9999;
        }

        /* Mobile Sidebar Styles */
        @media (max-width: 767.98px) {
            .sidebar {
                position: fixed;
                top: 0;
                left: 0;
                height: 100vh;
                z-index: 1050;
                transform: translateX(-100%);
                transition: transform 0.3s ease-in-out;
                width: 280px !important;
                padding-top: 60px;
            }

            .sidebar.show {
                transform: translateX(0);
            }

            .sidebar.collapsing {
                transform: translateX(-100%);
            }

            .sidebar-backdrop {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                z-index: 1040;
                display: none;
            }

            .sidebar-backdrop.show {
                display: block;
            }

            .main-content {
                padding: 15px;
                width: 100% !important;
            }

            .navbar {
                margin-bottom: 15px !important;
                padding: 10px 15px !important;
            }

            .hamburger-btn {
                display: flex !important;
                align-items: center;
                justify-content: center;
                width: 44px;
                height: 44px;
                min-width: 44px;
                border-radius: 8px;
                background: #f8f9fa;
                border: 1px solid #dee2e6;
            }

            .hamburger-btn i {
                font-size: 1.5rem;
                color: #495057;
            }

            .container-fluid {
                padding: 0 10px !important;
            }

            .card {
                margin-bottom: 15px !important;
            }
        }

        @media (min-width: 768px) {
            .hamburger-btn {
                display: none !important;
            }

            .sidebar-backdrop {
                display: none !important;
            }
        }
    </style>
    
    {% block extra_css %}{% endblock %}
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar Backdrop (mobile only) -->
            {% if current_user.is_authenticated %}
            <div class="sidebar-backdrop" id="sidebarBackdrop" onclick="toggleSidebar()"></div>

            <!-- Sidebar -->
            <nav class="col-md-3 col-lg-2 d-md-block sidebar" id="sidebarMenu">
                <div class="position-sticky pt-3">
                    <div class="text-center mb-4 px-3">
                        <!-- Logo using actual image -->
                        <img src="{{ url_for('static', filename='logo.png') }}" 
                             alt="BITCRM Logo"
                             class="mb-2"
                             style="height: 40px; width: auto; max-width: 100px; object-fit: contain;">
                        <small class="text-white-50">{{ _('Customer Relationship Management') }}</small>
                    </div>

                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link {% if request.endpoint == 'main.dashboard' %}active{% endif %}"
                               href="{{ url_for('main.dashboard') }}">
                                <i class="bi bi-speedometer2"></i>
                                {{ _('Dashboard') }}
                            </a>
                        </li>

                        {% if current_user.can_access_leads() %}
                        <li class="nav-item">
                            <a class="nav-link {% if 'leads' in request.endpoint %}active{% endif %}"
                               href="{{ url_for('leads.index') }}">
                                <i class="bi bi-people"></i>
                                {{ _('Sales Leads') }}
                            </a>
                        </li>
                        {% endif %}

                        <li class="nav-item">
                            <a class="nav-link {% if 'pipeline' in request.endpoint %}active{% endif %}"
                               href="{{ url_for('pipeline.index') }}">
                                <i class="bi bi-graph-up"></i>
                                {{ _('Pipeline') }}
                            </a>
                        </li>

                        <li class="nav-item">
                            <a class="nav-link {% if 'tasks' in request.endpoint %}active{% endif %}"
                               href="{{ url_for('tasks.index') }}">
                                <i class="bi bi-check-circle"></i>
                                {{ _('Tasks') }}
                            </a>
                        </li>

                        <li class="nav-item">
                            <a class="nav-link {% if 'activities' in request.endpoint or request.endpoint == 'main.activities' %}active{% endif %}"
                               href="{{ url_for('main.activities') }}">
                                <i class="bi bi-clock-history"></i>
                                {{ _('Activities') }}
                            </a>
                        </li>

                        {% if current_user.is_admin() %}
                        <li class="nav-item">
                            <a class="nav-link {% if 'admin' in request.endpoint %}active{% endif %}"
                               href="{{ url_for('admin.users') }}">
                                <i class="bi bi-gear"></i>
                                {{ _('Admin') }}
                            </a>
                        </li>
                        {% endif %}
                    </ul>
                </div>
            </nav>
            {% endif %}
            
            <!-- Main Content -->
            <main class="{% if current_user.is_authenticated %}col-md-9 ms-sm-auto col-lg-10 px-md-4{% endif %} main-content">
                <!-- Top Navigation -->
                {% if current_user.is_authenticated %}
                <nav class="navbar navbar-expand-lg navbar-light mb-4 rounded">
                    <div class="container-fluid">
                        <!-- Hamburger Button (Mobile) -->
                        <button class="hamburger-btn me-3" type="button" onclick="toggleSidebar()" aria-label="Toggle sidebar">
                            <i class="bi bi-list"></i>
                        </button>

                        <!-- Logo in main content area - Using actual logo image -->
                        <img src="{{ url_for('static', filename='logo.png') }}" 
                             alt="BITCRM Logo"
                             class="d-none d-lg-block me-3"
                             style="height: 40px; width: auto; max-width: 100px; object-fit: contain;">
                        <img src="{{ url_for('static', filename='logo.png') }}" 
                             alt="BITCRM Logo"
                             class="d-lg-none me-2"
                             style="height: 32px; width: auto; max-width: 80px; object-fit: contain;">

                        <div class="d-flex align-items-center ms-auto">
                            <!-- Manual Button -->
                            <a href="{{ url_for('main.manual') }}" class="btn btn-outline-info me-3" title="{{ _('User Manual') }}">
                                <i class="bi bi-book"></i>
                                {% if g.lang == 'zh' %}{{ _('Manual') }}{% else %}Manual{% endif %}
                            </a>

                            <!-- Column Settings Button (for list pages) -->
                            {% block column_settings_btn %}{% endblock %}

                            <!-- Language Switcher -->
                            <div class="dropdown me-3">
                                <a class="btn btn-outline-secondary dropdown-toggle language-switcher"
                                   href="#" role="button" data-bs-toggle="dropdown">
                                    <i class="bi bi-globe"></i>
                                    {% if g.lang == 'zh' %}ä¸­æ–‡{% else %}EN{% endif %}
                                </a>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    <li>
                                        <a class="dropdown-item" href="{{ url_for('main.set_language', lang='en') }}">
                                            ðŸ‡ºðŸ‡¸ English
                                        </a>
                                    </li>
                                    <li>
                                        <a class="dropdown-item" href="{{ url_for('main.set_language', lang='zh') }}">
                                            ðŸ‡¨ðŸ‡³ ä¸­æ–‡
                                        </a>
                                    </li>
                                </ul>
                            </div>

                            <!-- User Menu -->
                            <div class="dropdown">
                                <a class="btn btn-outline-primary dropdown-toggle" href="#" role="button"
                                   data-bs-toggle="dropdown">
                                    <i class="bi bi-person-circle"></i>
                                    {{ current_user.username }}
                                </a>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    <li><span class="dropdown-item-text">
                                        <small class="text-muted">{{ current_user.role|capitalize }}</small>
                                    </span></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li>
                                        <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#changePasswordModal">
                                            <i class="bi bi-key"></i>
                                            {{ _('Change Password') }}
                                        </a>
                                    </li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li>
                                        <a class="dropdown-item" href="{{ url_for('main.logout') }}">
                                            <i class="bi bi-box-arrow-right"></i>
                                            {{ _('Logout') }}
                                        </a>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </nav>
                {% endif %}
                
                <!-- Flash Messages -->
                {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                <div class="flash-messages">
                    {% for category, message in messages %}
                    <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
                {% endwith %}
                
                <!-- Page Content -->
                {% block content %}{% endblock %}
            </main>
        </div>
    </div>
    
    <!-- Column Settings Offcanvas -->
    {% block column_settings_offcanvas %}{% endblock %}
    
    <!-- Toast Container -->
    <div class="toast-notification">
        <div id="saveToast" class="toast align-items-center text-bg-success border-0" role="alert">
            <div class="d-flex">
                <div class="toast-body">
                    <i class="bi bi-check-circle me-2"></i>
                    <span id="toastMessage">Settings saved!</span>
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div class="modal fade" id="changePasswordModal" tabindex="-1" aria-labelledby="changePasswordModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="changePasswordModalLabel">{{ _('Change Password') }}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="changePasswordForm">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="currentPassword" class="form-label">{{ _('Current Password') }} *</label>
                            <input type="password" class="form-control" id="currentPassword" name="current_password" required>
                        </div>
                        <div class="mb-3">
                            <label for="newPassword" class="form-label">{{ _('New Password') }} *</label>
                            <input type="password" class="form-control" id="newPassword" name="new_password" required minlength="6">
                        </div>
                        <div class="mb-3">
                            <label for="confirmNewPassword" class="form-label">{{ _('Confirm New Password') }} *</label>
                            <input type="password" class="form-control" id="confirmNewPassword" name="confirm_password" required>
                        </div>
                        <div id="passwordError" class="alert alert-danger d-none"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Cancel') }}</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-circle me-1"></i>{{ _('Save') }}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Global Column Settings Script -->
    <script>
        // Column settings page configuration
        window.columnSettingsPage = null;
        window.columnSettingsAvailable = [];
        window.columnSettingsSelected = [];
        
        // Initialize column settings
        async function initColumnSettings(page, availableColumns, defaultSelected) {
            window.columnSettingsPage = page;
            window.columnSettingsAvailable = availableColumns;
            
            // Fetch user's preferences
            try {
                const response = await fetch(`/api/column-preferences/${page}`);
                const prefs = await response.json();
                
                if (prefs.columns && prefs.columns.length > 0) {
                    window.columnSettingsSelected = prefs.columns;
                } else {
                    window.columnSettingsSelected = defaultSelected;
                }
            } catch (e) {
                console.error('Error fetching column preferences:', e);
                window.columnSettingsSelected = defaultSelected;
            }
            
            renderColumnLists();
            initSortable();
        }
        
        // Render column lists
        function renderColumnLists() {
            const availableList = document.getElementById('availableColumnsList');
            const selectedList = document.getElementById('selectedColumnsList');
            
            if (!availableList || !selectedList) return;
            
            availableList.innerHTML = '';
            selectedList.innerHTML = '';
            
            // Render available columns (not selected)
            window.columnSettingsAvailable.forEach(col => {
                if (!window.columnSettingsSelected.includes(col.key)) {
                    const item = createColumnItem(col, false);
                    availableList.appendChild(item);
                }
            });
            
            // Render selected columns
            window.columnSettingsSelected.forEach(colKey => {
                const col = window.columnSettingsAvailable.find(c => c.key === colKey);
                if (col) {
                    const item = createColumnItem(col, true);
                    selectedList.appendChild(item);
                }
            });
            
            // Update checkboxes
            document.querySelectorAll('.column-item input[type="checkbox"]').forEach(cb => {
                cb.checked = window.columnSettingsSelected.includes(cb.dataset.column);
            });
        }
        
        // Create column item
        function createColumnItem(col, isSelected) {
            const div = document.createElement('div');
            div.className = 'column-item';
            div.dataset.column = col.key;
            div.innerHTML = `
                <i class="bi bi-grip-vertical drag-handle"></i>
                <input type="checkbox" class="form-check-input" data-column="${col.key}" ${isSelected ? 'checked' : ''}>
                <span class="column-label">${col.label}</span>
            `;
            
            // Toggle checkbox on click
            div.querySelector('.column-label').addEventListener('click', () => {
                const checkbox = div.querySelector('input[type="checkbox"]');
                checkbox.checked = !checkbox.checked;
                toggleColumn(checkbox.dataset.column, checkbox.checked);
            });
            
            // Checkbox change handler
            div.querySelector('input[type="checkbox"]').addEventListener('change', (e) => {
                toggleColumn(e.target.dataset.column, e.target.checked);
            });
            
            return div;
        }
        
        // Toggle column selection
        function toggleColumn(colKey, selected) {
            if (selected && !window.columnSettingsSelected.includes(colKey)) {
                window.columnSettingsSelected.push(colKey);
            } else if (!selected) {
                window.columnSettingsSelected = window.columnSettingsSelected.filter(c => c !== colKey);
            }
            renderColumnLists();
            saveColumnPreferences();
        }
        
        // Initialize SortableJS
        function initSortable() {
            const selectedList = document.getElementById('selectedColumnsList');
            if (!selectedList) return;
            
            new Sortable(selectedList, {
                animation: 150,
                handle: '.drag-handle',
                ghostClass: 'sortable-ghost',
                onEnd: function(evt) {
                    // Update order based on new DOM order
                    const newOrder = [];
                    selectedList.querySelectorAll('.column-item').forEach(item => {
                        newOrder.push(item.dataset.column);
                    });
                    window.columnSettingsSelected = newOrder;
                    saveColumnPreferences();
                }
            });
        }
        
        // Save column preferences
        async function saveColumnPreferences() {
            if (!window.columnSettingsPage) return;
            
            try {
                const response = await fetch(`/api/column-preferences/${window.columnSettingsPage}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        columns: window.columnSettingsSelected
                    })
                });
                
                if (response.ok) {
                    showToast('Settings saved!');
                }
            } catch (e) {
                console.error('Error saving preferences:', e);
            }
        }
        
        // Show toast notification
        function showToast(message) {
            const toast = new bootstrap.Toast(document.getElementById('saveToast'));
            document.getElementById('toastMessage').textContent = message;
            toast.show();
        }
        
        // Reload page to apply changes
        function applyColumnChanges() {
            window.location.reload();
        }

        // Sidebar toggle for mobile
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebarMenu');
            const backdrop = document.getElementById('sidebarBackdrop');

            if (sidebar.classList.contains('show')) {
                sidebar.classList.remove('show');
                backdrop.classList.remove('show');
            } else {
                sidebar.classList.add('show');
                backdrop.classList.add('show');
            }
        }

        // Close sidebar when pressing Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const sidebar = document.getElementById('sidebarMenu');
                const backdrop = document.getElementById('sidebarBackdrop');
                if (sidebar.classList.contains('show')) {
                    sidebar.classList.remove('show');
                    backdrop.classList.remove('show');
                }
            }
        });

        // Change Password Form Validation
        document.getElementById('changePasswordForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmNewPassword = document.getElementById('confirmNewPassword').value;
            const errorDiv = document.getElementById('passwordError');
            const submitBtn = this.querySelector('button[type="submit"]');

            // Clear previous error
            errorDiv.classList.add('d-none');
            errorDiv.textContent = '';

            // Validation
            if (!currentPassword || !newPassword || !confirmNewPassword) {
                errorDiv.textContent = 'All password fields are required.';
                errorDiv.classList.remove('d-none');
                return;
            }

            if (newPassword.length < 6) {
                errorDiv.textContent = 'New password must be at least 6 characters.';
                errorDiv.classList.remove('d-none');
                return;
            }

            if (newPassword !== confirmNewPassword) {
                errorDiv.textContent = 'New password and confirm password do not match.';
                errorDiv.classList.remove('d-none');
                return;
            }

            // Submit form
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Saving...';

            try {
                const response = await fetch('/api/change-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        current_password: currentPassword,
                        new_password: newPassword
                    })
                });

                const data = await response.json();

                if (data.success) {
                    // Show success toast
                    showToast('Password changed successfully!');
                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('changePasswordModal'));
                    modal.hide();
                    // Reset form
                    this.reset();
                } else {
                    errorDiv.textContent = data.error || 'An error occurred. Please try again.';
                    errorDiv.classList.remove('d-none');
                }
            } catch (err) {
                errorDiv.textContent = 'Network error. Please try again.';
                errorDiv.classList.remove('d-none');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="bi bi-check-circle me-1"></i>Save';
            }
        });

        // Reset form when modal is closed
        document.getElementById('changePasswordModal').addEventListener('hidden.bs.modal', function() {
            document.getElementById('changePasswordForm').reset();
            document.getElementById('passwordError').classList.add('d-none');
        });
    </script>
    
    {% block extra_js %}{% endblock %}
</body>
</html>
